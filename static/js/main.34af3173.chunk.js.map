{"version":3,"sources":["decentracar/util/actor.ts","decentracar/messages/index.ts","imgs/driver.png","imgs/rider.png","decentracar/util/appcommunity.ts","decentracar/simulation.ts","App.tsx","serviceWorker.ts","index.tsx","decentracar/driver/index.ts","decentracar/company/service.ts","decentracar/rider/index.ts","../node_modules/tupelo-wasm-sdk/lib/js/go sync","decentracar/util/vector.ts","decentracar/util/emittinglogger.ts","decentracar/util/locations.ts"],"names":["log","debug","SimpleSyncher","name","queue","started","this","undefined","queuedFn","pop","fn","toString","resp","res","rej","length","run","Promise","resolve","reject","push","messageType","certificationTopic","ridersTopic","serialize","msg","dagCBOR","util","deserialize","bits","module","exports","_appPromise","devCommunity","Simulation","opts","drivers","riders","interval","community","tickCount","riderProbability","i","driverCount","Driver","location","randomGeo","mapCenter","clearInterval","EcdsaKey","generate","key","ChainTree","newEmptyTree","blockservice","tree","id","Error","service","DecentraCarService","did","start","tick","possiblyCreateRider","emit","Math","random","r","Rider","once","index","indexOf","splice","milliseconds","setInterval","EventEmitter","subDirectory","window","pathname","console","Go","setWasmPath","position","driverPng","require","riderPng","driverIcon","Icon","iconUrl","iconRetinaUrl","iconSize","Point","className","riderIcon","DriverMarker","driver","Marker","y","x","icon","Popup","acceptedRider","Tooltip","RiderMarker","rider","SimulationDisplay","simulation","logs","markers","d","Column","size","Map","zoom","center","TileLayer","url","attribution","LayerGroup","LogDisplay","txt","Item","src","App","useState","setSimulation","appLogs","setAppLogs","setTick","handleStart","a","sim","process","Community","getDefault","c","fromNotaryGroupToml","setDefault","on","num","tickEvery","logStrings","unshift","join","href","onClick","Boolean","hostname","match","ReactDOM","render","document","getElementById","navigator","serviceWorker","ready","then","registration","unregister","emittingLogger","velocity","acceleration","wandering","riderLocation","destination","offering","hasRider","registered","messenger","startPromise","syncher","Vector","faker","findName","CommunityMessenger","Buffer","from","node","pubsub","subscribe","handleSelfMessages","bind","handleRidersMessage","registerAsDriver","playTransactions","setDataTransaction","nextUpdate","publish","type","didRegistration","env","getFrom_asU8","offer","driverDid","driverLocation","getPayload_asU8","offerReject","offerAccept","typedMsg","riderDid","send","dist","follow","dropoff","wander","riding","update","rotate","PI","add","target","arrive","dest","copy","sub","setMag","applyForce","limit","MAX_FORCE","f","mag","mul","_findOrCreateTree","handleRegistration","tryCount","getTip","tip","setTimeout","handleNew","CID","store","resolveData","value","isCID","stopped","acceptedDriver","offers","subFn","firstOfferTick","registerAsRider","unsubscribe","askForRide","possiblyAcceptRide","stop","closest","closestDist","acceptRide","rejectRide","rideOffer","rideRequest","riderDID","webpackEmptyContext","req","e","code","keys","v","s","sqrt","div","atan2","m","angle","cos","sin","setAngle","l","amt","dx","dy","EmittingLogger","debugger","args","radius","y0","x0","rd","u","w","t"],"mappings":"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","file":"static/js/main.34af3173.chunk.js","sourcesContent":["import debug from 'debug'\n\nconst log = debug(\"util:syncher\")\n\ninterface queuedFunction {\n    fn:Function\n    res:Function\n    rej:Function\n}\n\n/**\n * SimpleActor is used to serialize function calls, it is a single threaded\n * actor that does one function after the next. Every send returns a promise\n * that is executed after the serialization\n */\nexport class SimpleSyncher {\n    private queue:queuedFunction[]\n    private started:boolean\n    private name?:string\n    constructor(name?:string) {\n        this.started = false\n        this.queue = []\n        this.name = name\n    }\n\n    private async run() {\n        const queuedFn = this.queue.pop()\n        if (queuedFn === undefined) {\n            log(this.name, ' stopping syncher')\n            this.started = false\n            return\n        }\n        try {\n            log(this.name, ' run fn', queuedFn.fn.toString())\n            const resp = await queuedFn.fn()\n            log(this.name, ' finish fn')\n            queuedFn.res(resp)\n        } catch(err) {\n            log(this.name, ' rejecting: ', err)\n            queuedFn.rej(err)\n        }\n        if (this.queue.length > 0) {\n            log(this.name, \"syncher queueing another\")\n            this.run()\n        } else {\n            this.started = false\n        }\n    }\n\n    send(fn:Function) {\n        const p = new Promise((resolve,reject) => {\n            this.queue.push({\n                fn:fn,\n                res: resolve,\n                rej:reject,\n            })\n            if (!this.started) {\n                log(this.name, \" not started, starting\")\n                this.started = true\n                this.run()\n                return\n            }\n            log(this.name, ' run already started')\n        })\n       \n        return p\n    }\n\n\n}","/// <reference path=\"../../@types/ipld-dag-cbor/index.d.ts\" />\n/* eslint-disable */\n\nimport dagCBOR from 'ipld-dag-cbor'\n\n/**\n * These would probably be better served as protobufs, but for demo purposes, I think it's clearer to just use Plain Old Javascript Objects\n */\n\nexport const certificationTopic = 'decentracar-certifications'\nexport const driverLocationTopic = 'decentracar-drivers'\nexport const ridersTopic = 'decentracar-riders'\n\nexport enum messageType {\n    offer,\n    offerReject,\n    offerAccept,\n    didRegistration,\n    rideRequest,\n    rideRequestResponse,\n    riding,\n    dropoff,\n}\n\n\n    export function serialize(msg:any):Uint8Array{\n        return dagCBOR.util.serialize(msg)\n    }\n\n    export function deserialize(bits:Uint8Array):any{\n        return dagCBOR.util.deserialize(bits)\n    }\n\n    export interface dcMessage {\n        type:messageType\n    }\n \n    export interface offer extends dcMessage {\n        type: messageType.offer\n        driverDid: string\n        driverLocation: [number,number]\n    }\n\n    export interface didRegistration extends dcMessage {\n        type: messageType.didRegistration\n        did:string\n    }\n\n    export interface rideRequest extends dcMessage {\n        type: messageType.rideRequest\n        riderDID:string\n        location:[number,number]\n    }\n\n    export interface rideRequestResponse extends dcMessage {\n        type: messageType.rideRequestResponse\n        driverDID:string\n        location:[number,number]\n    }\n\n    export interface offerReject extends dcMessage {\n        type: messageType.offerReject\n        offer: offer\n    }\n\n    export interface offerAccept extends dcMessage {\n        type: messageType.offerAccept\n        riderDid: string\n        location:[number,number]\n        destination:[number,number]\n    }\n\n    export interface riding extends dcMessage {\n        type: messageType.riding\n        driverDid: string\n        location: [number,number]\n    }\n\n    export interface dropoff extends dcMessage {\n        type: messageType.dropoff,\n        driverDid: string\n    }\n","module.exports = __webpack_public_path__ + \"static/media/driver.511e2960.png\";","module.exports = __webpack_public_path__ + \"static/media/rider.23486b95.png\";","\nimport { Community } from 'tupelo-wasm-sdk';\nimport debug from 'debug';\n\nconst log = debug(\"appcommunity\")\n\nlet _appPromise: Promise<Community>\n\nconst devCommunity = `\nid = \"tupelolocal\"\nBootstrapAddresses = [\n    \"/ip4/127.0.0.1/tcp/34001/ipfs/16Uiu2HAm3TGSEKEjagcCojSJeaT5rypaeJMKejijvYSnAjviWwV5\",\n    \"/ip4/127.0.0.1/tcp/50000/ws/ipfs/16Uiu2HAm4hjC7zZTSN5KAp187vn52bZMsC8VaVdtrci7HD4aZcU7\",\n]\n[[signers]]\nVerKeyHex = \"0x15796b266a7d6b7c6b29c5bf97ad376fe8457e4d56bb0612ec8703c65ca7b6bb5dca004d55f5238d7764cd100c9e9cac3c5abce902bae8a5f9c29de716a145595b071b1b7038a48b4f6f88e7664b38c02062f64b3ceb499e4cbb82361457dcd731f5b48901871e7fd56a9c91ab3e06d3f7cb27288962686d9a05e02c1482f01f\"\nDestKeyHex = \"0x04f6dee3f7da1da58afd6ee58ea6b858fb67664fc6e2240bb6e3a75c0e1db9bbef5f413c8604bb864513d3cf27eca60b539b048b2a08f8799570c14dfb73f3f391\"\n\n[[signers]]\nVerKeyHex = \"0x7be8c92c8c295ef3e97be28f469f5f94d10ee7db4d202776bee5cf55c62d508a0c3550a19342d768ff073c0798ce003646df586ef588a9e9443a0ca86a234ed15150dc98ecc3f1071649fca03426f1c8c215a90752f51faa3e2e788e1dae2e9e5cf87c1ca4239a0949a0ba6ea09c061a538372cc4230dedafae929b170ad7704\"\nDestKeyHex = \"0x0438b196bddb9c3ec395b8ccb07bdab44ec768c084e7141b09ac5638d47fffbd5e7b7623f499a2e714e31464a356a0e30ad7c93045b6cd9957b45e957cc15dcb99\"\n\n[[signers]]\nVerKeyHex = \"0x88aefad94805db01cacaf190f47bc9e40f584b5085c651da168ac4034d570b4750bf7b23803d204e483e407a5ca34ee7f7a434733346451cf3f5d26c0d11e5ac45398a03fbba2d3b0dfc21cdf14615430cea394bd9423d8527eaa82a96aa6d20655724d99770ee3488b6537d6be143b84b21ad5ee12c190048757fe453313fd2\"\nDestKeyHex = \"0x0468924bd1341b5cec1fed888aaf1e3caa94e7d0f13d4f4573b01b296374b9e710a58a7b40e7161c0bcf7fd41832441ca21076f3846e854c8d8c640f2469a552b1\"\n`\n\nexport function getAppCommunity(): Promise<Community> {\n    log(\"getAppCommunity\")\n    if (_appPromise !== undefined) {\n        return _appPromise\n    }\n    _appPromise = new Promise(async (resolve, reject) => {\n        let c: Community\n        switch (process.env.NODE_ENV) {\n            case 'production':\n                log('using production community')\n                c = await Community.getDefault()\n                break;\n            default:\n                log('using development community')\n                c = await Community.fromNotaryGroupToml(devCommunity)\n                Community.setDefault(c)\n        }\n        resolve(c)\n    })\n    return _appPromise\n}","import { Driver } from './driver'\nimport { Community, EcdsaKey, ChainTree } from 'tupelo-wasm-sdk'\nimport { randomGeo, mapCenter } from './util/locations'\nimport { EventEmitter } from 'events'\nimport { DecentraCarService } from './company/service'\nimport { Rider } from './rider'\nimport debug from 'debug'\n\nconst log = debug(\"decentracar:simulation\")\n\ninterface ISimulationOpts {\n    driverCount: number\n    riderProbability: number // how many ticks out of 100 will a rider be created?\n    community: Promise<Community>\n}\n\nexport class Simulation extends EventEmitter {\n    drivers: Driver[]\n    riders: Rider[]\n    private interval?: number\n    community: Promise<Community>\n    tickCount: number\n    riderProbability:number\n\n    constructor(opts: ISimulationOpts) {\n        super()\n        this.tickCount = 0;\n        this.community = opts.community\n        let drivers: Driver[] = []\n        for (let i = 0; i < opts.driverCount; i++) {\n            drivers[i] = new Driver({\n                community: opts.community,\n                location: randomGeo(mapCenter, 5000)\n            })\n        }\n        this.riderProbability = opts.riderProbability\n        this.drivers = drivers\n        this.riders = []\n    }\n\n    stop() {\n        log('simulation stopped')\n        if (this.interval === undefined) {\n            return\n        }\n        clearInterval(this.interval)\n    }\n\n    async start() {\n        log('starting simulation')\n        const community = await this.community\n        let key = await EcdsaKey.generate()\n        let tree = await ChainTree.newEmptyTree(community.blockservice, key)\n        const id = await tree.id()\n        if (id === null) {\n            throw new Error(\"unknown tree id\")\n        }\n\n        const service = new DecentraCarService({\n            community: community,\n            key: key,\n            did: id,\n        })\n        await service.start()\n        for (let d of this.drivers) {\n            d.start()\n        }\n       \n    }\n\n    async tick() {\n        for (let d of this.drivers) {\n            d.tick()\n        }\n        this.possiblyCreateRider()\n        for (let r of this.riders) {\n            r.tick()\n        }\n        this.tickCount++\n        this.emit('tick', this.tickCount);\n    }\n\n    async possiblyCreateRider() {\n        if (this.tickCount < 5) {\n            return // don't do anything until 5 ticks have passed\n        }\n        if (Math.random() * 100 < this.riderProbability) {\n            const r = new Rider({\n                community: this.community,\n                location: randomGeo(mapCenter, 5000)\n            })\n            r.start()\n            r.once('stopped', ()=> {\n                let index = this.riders.indexOf(r)\n                this.riders.splice(index, 1)\n            })\n            this.riders.push(r)\n        }\n    }\n\n    async tickEvery(milliseconds:number) {\n        setInterval(()=> {\n            this.tick()\n        }, milliseconds)\n    }\n\n}","import React, { useState } from 'react';\nimport 'react-bulma-components/dist/react-bulma-components.min.css';\nimport './App.css';\nimport { Map, Marker, Popup, TileLayer, Tooltip, LayerGroup } from 'react-leaflet';\nimport { getAppCommunity } from './decentracar/util/appcommunity';\nimport { Simulation } from './decentracar/simulation'\nimport { Icon, Point } from 'leaflet'\nimport { Driver } from './decentracar/driver';\nimport { Rider } from './decentracar/rider';\nimport { Container, Button, Columns, Navbar, Content, Box, Media, Image } from 'react-bulma-components';\nimport {logs} from './decentracar/util/emittinglogger';\n\nimport 'tupelo-wasm-sdk' // in order to get the Go global\n\ndeclare const Go: any;\n\nconst subDirectory = window.location.pathname\nconsole.log(\"subDirectory \", subDirectory)\n\nif (subDirectory !== '/') {\n    console.log(\"setting wasmpath to: \",  subDirectory + \"tupelo.wasm\")\n    Go.setWasmPath(subDirectory + \"tupelo.wasm\");\n}\n\nconst position: [number, number] = [52.491362, 13.362029];\n\nconst driverPng:any = require('./imgs/driver.png')\nconst riderPng:any = require('./imgs/rider.png')\n\nconst driverIcon = new Icon({\n  iconUrl: driverPng,\n  iconRetinaUrl: driverPng,\n  iconSize: new Point(30, 30),\n  className: 'leaflet-div-icon'\n});\n\nconst riderIcon = new Icon({\n  iconUrl: riderPng,\n  iconRetinaUrl: riderPng,\n  iconSize: new Point(30, 30),\n  className: 'leaflet-div-icon'\n})\n\nconst DriverMarker = ({ driver }: { driver: Driver }) => {\n  return (\n    <Marker position={[driver.location.y, driver.location.x]} icon={driverIcon}>\n      <Popup>\n        A Driver: {driver.name}\n        Accepted Rider: {driver.acceptedRider}\n      </Popup>\n      <Tooltip>{driver.name}</Tooltip>\n    </Marker>\n  )\n}\n\nconst RiderMarker = ({ rider }: { rider: Rider }) => {\n  return (\n    <Marker position={[rider.location.y, rider.location.x]} icon={riderIcon}>\n      <Popup>A Rider: {rider.name}</Popup>\n      <Tooltip>{rider.name}</Tooltip>\n    </Marker>\n  )\n}\n\nconst SimulationDisplay = ({ simulation, logs }: { simulation: Simulation, logs:JSX.Element[] }) => {\n  let markers: JSX.Element[] = []\n  for (let d of simulation.drivers) {\n    markers.push(<DriverMarker key={d.name} driver={d} />)\n  }\n\n  for (let r of simulation.riders) {\n    markers.push(<RiderMarker key={r.name} rider={r} />)\n  }\n\n\n  return (\n    <Columns>\n      <Columns.Column size={\"half\"}>\n        <Map zoom={12} center={position}>\n          <TileLayer\n            url=\"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png\"\n            attribution=\"&copy; <a href=&quot;http://osm.org/copyright&quot;>OpenStreetMap</a> contributors\"\n          />\n          <LayerGroup>\n            {markers}\n          </LayerGroup>\n        </Map>\n      </Columns.Column>\n      <Columns.Column>\n        <Content className=\"app-logs\">\n          <h2>Events</h2>\n          <div>\n            {logs}\n          </div>\n        </Content>\n      </Columns.Column>\n    </Columns>\n  )\n}\n\n\nconst LogDisplay = ({txt,icon}:{txt:string,icon:any}) => {\n  return (\n    <Box key={txt}>\n      <Media>\n        <Media.Item>\n         <Image size={32} src={icon}></Image>\n        </Media.Item>\n        <Media.Item>\n          <Content>\n          <p>{txt}</p>\n          </Content>\n        </Media.Item>\n      </Media>\n    </Box>\n  )\n}\n\nconst App: React.FC = () => {\n\n  const [simulation, setSimulation] = useState(null as null | Simulation)\n  const [appLogs, setAppLogs] = useState([] as JSX.Element[])\n  const [tick, setTick] = useState(0)\n\n  const handleStart = async () => {\n    const sim = new Simulation({\n      community: getAppCommunity(),\n      driverCount: 10,\n      riderProbability: 5,\n    })\n\n    sim.on('tick', (num) => {\n      setTick(num)\n    })\n    sim.start()\n    sim.tickEvery(1000)\n    \n    logs.on('decentracar:driver', (...logStrings:any[]) => {\n      appLogs.unshift(<LogDisplay icon={driverPng} txt={logStrings.join(' ')}/>)\n      setAppLogs(appLogs)\n    })\n\n    logs.on('decentracar:rider', (...logStrings:any[]) => {\n      appLogs.unshift(<LogDisplay icon={riderPng} txt={logStrings.join(' ')}/>)\n      setAppLogs(appLogs)\n    })\n\n    setSimulation(sim)\n  }\n\n  return (\n    <div>\n      <Container>\n        <Navbar>\n          <Navbar.Item>Decentracar Simulation</Navbar.Item>\n          <Navbar.Item>tick: {tick}</Navbar.Item>\n        </Navbar>\n        {simulation ? <SimulationDisplay simulation={simulation} logs={appLogs} /> :\n          <Content>\n            <p>This is a simulation of a simplified decentralized car sharing app.</p>\n            <p>You can read more about it here: <a href=\"https://www.tupelo.org/posts/decentracar\">https://www.tupelo.org/posts/decentracar</a>. \n            Github repo is here: <a href=\"https://github.com/quorumcontrol/decentracar\">https://github.com/quorumcontrol/decentracar</a></p>\n            <p><Button onClick={handleStart}>Click here to start</Button></p>\n            <p>This simulation only works on desktop browsers (and not safari).</p>\n          </Content>\n        }\n      </Container>\n    </div>\n  );\n}\n\nexport default App;\n","// This optional code is used to register a service worker.\n// register() is not called by default.\n\n// This lets the app load faster on subsequent visits in production, and gives\n// it offline capabilities. However, it also means that developers (and users)\n// will only see deployed updates on subsequent visits to a page, after all the\n// existing tabs open on the page have been closed, since previously cached\n// resources are updated in the background.\n\n// To learn more about the benefits of this model and instructions on how to\n// opt-in, read https://bit.ly/CRA-PWA\n\nconst isLocalhost = Boolean(\n  window.location.hostname === 'localhost' ||\n    // [::1] is the IPv6 localhost address.\n    window.location.hostname === '[::1]' ||\n    // 127.0.0.1/8 is considered localhost for IPv4.\n    window.location.hostname.match(\n      /^127(?:\\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/\n    )\n);\n\ntype Config = {\n  onSuccess?: (registration: ServiceWorkerRegistration) => void;\n  onUpdate?: (registration: ServiceWorkerRegistration) => void;\n};\n\nexport function register(config?: Config) {\n  if (process.env.NODE_ENV === 'production' && 'serviceWorker' in navigator) {\n    // The URL constructor is available in all browsers that support SW.\n    const publicUrl = new URL(\n      (process as { env: { [key: string]: string } }).env.PUBLIC_URL,\n      window.location.href\n    );\n    if (publicUrl.origin !== window.location.origin) {\n      // Our service worker won't work if PUBLIC_URL is on a different origin\n      // from what our page is served on. This might happen if a CDN is used to\n      // serve assets; see https://github.com/facebook/create-react-app/issues/2374\n      return;\n    }\n\n    window.addEventListener('load', () => {\n      const swUrl = `${process.env.PUBLIC_URL}/service-worker.js`;\n\n      if (isLocalhost) {\n        // This is running on localhost. Let's check if a service worker still exists or not.\n        checkValidServiceWorker(swUrl, config);\n\n        // Add some additional logging to localhost, pointing developers to the\n        // service worker/PWA documentation.\n        navigator.serviceWorker.ready.then(() => {\n          console.log(\n            'This web app is being served cache-first by a service ' +\n              'worker. To learn more, visit https://bit.ly/CRA-PWA'\n          );\n        });\n      } else {\n        // Is not localhost. Just register service worker\n        registerValidSW(swUrl, config);\n      }\n    });\n  }\n}\n\nfunction registerValidSW(swUrl: string, config?: Config) {\n  navigator.serviceWorker\n    .register(swUrl)\n    .then(registration => {\n      registration.onupdatefound = () => {\n        const installingWorker = registration.installing;\n        if (installingWorker == null) {\n          return;\n        }\n        installingWorker.onstatechange = () => {\n          if (installingWorker.state === 'installed') {\n            if (navigator.serviceWorker.controller) {\n              // At this point, the updated precached content has been fetched,\n              // but the previous service worker will still serve the older\n              // content until all client tabs are closed.\n              console.log(\n                'New content is available and will be used when all ' +\n                  'tabs for this page are closed. See https://bit.ly/CRA-PWA.'\n              );\n\n              // Execute callback\n              if (config && config.onUpdate) {\n                config.onUpdate(registration);\n              }\n            } else {\n              // At this point, everything has been precached.\n              // It's the perfect time to display a\n              // \"Content is cached for offline use.\" message.\n              console.log('Content is cached for offline use.');\n\n              // Execute callback\n              if (config && config.onSuccess) {\n                config.onSuccess(registration);\n              }\n            }\n          }\n        };\n      };\n    })\n    .catch(error => {\n      console.error('Error during service worker registration:', error);\n    });\n}\n\nfunction checkValidServiceWorker(swUrl: string, config?: Config) {\n  // Check if the service worker can be found. If it can't reload the page.\n  fetch(swUrl)\n    .then(response => {\n      // Ensure service worker exists, and that we really are getting a JS file.\n      const contentType = response.headers.get('content-type');\n      if (\n        response.status === 404 ||\n        (contentType != null && contentType.indexOf('javascript') === -1)\n      ) {\n        // No service worker found. Probably a different app. Reload the page.\n        navigator.serviceWorker.ready.then(registration => {\n          registration.unregister().then(() => {\n            window.location.reload();\n          });\n        });\n      } else {\n        // Service worker found. Proceed as normal.\n        registerValidSW(swUrl, config);\n      }\n    })\n    .catch(() => {\n      console.log(\n        'No internet connection found. App is running in offline mode.'\n      );\n    });\n}\n\nexport function unregister() {\n  if ('serviceWorker' in navigator) {\n    navigator.serviceWorker.ready.then(registration => {\n      registration.unregister();\n    });\n  }\n}\n","import React from 'react';\nimport ReactDOM from 'react-dom';\nimport './index.css';\nimport App from './App';\nimport * as serviceWorker from './serviceWorker';\n\nReactDOM.render(<App />, document.getElementById('root'));\n\n// If you want your app to work offline and load faster, you can change\n// unregister() to register() below. Note this comes with some pitfalls.\n// Learn more about service workers: https://bit.ly/CRA-PWA\nserviceWorker.unregister();\n","import { EcdsaKey, ChainTree, Community, CommunityMessenger, setDataTransaction } from 'tupelo-wasm-sdk';\nimport faker from 'faker';\nimport Vector from '../util/vector'\nimport { EventEmitter } from 'events';\nimport { Envelope } from 'tupelo-messages';\nimport { certificationTopic, ridersTopic, messageType, serialize, dropoff, riding, deserialize, offer, dcMessage, offerAccept, didRegistration } from '../messages';\nimport { SimpleSyncher } from '../util/actor';\nimport {emittingLogger} from \"../util/emittinglogger\";\n\nconst log = emittingLogger('decentracar:driver')\n\nconst MAX_SPEED = .001,\n    MIN_SPEED = .000016,\n    MAX_FORCE = .0001,\n    ARRIVAL_DIST = .002\n\ninterface IDriverOpts {\n    community: Promise<Community>\n    location: Vector\n}\n\nexport class Driver extends EventEmitter {\n    community: Promise<Community>\n    tree?: ChainTree\n    key?: EcdsaKey\n    id?: string\n    name: string\n    location: Vector\n    velocity: Vector\n    acceleration: Vector\n    wandering: Vector\n\n    riderLocation?: Vector\n    acceptedRider?: string\n    destination?: Vector\n    offering: boolean\n    hasRider:boolean\n    registered: boolean\n\n    private messenger?: CommunityMessenger\n    private startPromise?: Promise<Driver>\n    private syncher:SimpleSyncher\n\n    constructor(opts: IDriverOpts) {\n        super();\n        this.community = opts.community;\n        this.location = opts.location;\n        this.velocity = new Vector(0, 0);\n        this.acceleration = new Vector(0, 0);\n        this.wandering = new Vector(Math.random() / 1000, Math.random() / 1000);\n        this.name = faker.name.findName();\n        this.registered = false;\n        this.offering = false;\n        this.hasRider = false;\n        this.syncher = new SimpleSyncher();\n    }\n\n    start() {\n        if (this.startPromise !== undefined) {\n            return this.startPromise\n        }\n        this.startPromise = new Promise(async (resolve, reject) => {\n            const community = await this.community\n            this.key = await EcdsaKey.generate()\n            this.tree = await ChainTree.newEmptyTree(community.blockservice, this.key)\n            const id = await this.tree.id()\n            if (id === null) {\n                reject(new Error(\"error getting id\"))\n                return\n            }\n            this.id = id\n            this.messenger = new CommunityMessenger(\"integrationtest\", 32, this.key, Buffer.from(this.id, 'utf8'), community.node.pubsub)\n            this.messenger.subscribe(this.id, this.handleSelfMessages.bind(this))\n            this.messenger.subscribe(ridersTopic, this.handleRidersMessage.bind(this))\n            await this.registerAsDriver()\n            // log(this.name, \" starting at \", this.location)\n            resolve(this)\n        })\n        return this.startPromise\n    }\n\n    async registerAsDriver() {\n        log(this.name, \" registering as driver\")\n        if (this.messenger === undefined || this.tree === undefined) {\n            throw new Error(\"need a tree and messenger to registerAsDriver\")\n        }\n        const c = await this.community\n        await c.playTransactions(this.tree, [setDataTransaction(\"_decentracar/type\", \"driver\")])\n        await c.nextUpdate()\n        this.messenger.publish(certificationTopic, serialize({\n            type: messageType.didRegistration,\n            did: this.id,\n        } as didRegistration))\n    }\n\n    async handleRidersMessage(env: Envelope) {\n        if (this.offering) {\n            return // ignore other messages for now\n        }\n        if (this.messenger === undefined || this.tree === undefined || this.id === undefined) {\n            throw new Error(\"need an id, tree and messenger to registerAsDriver\")\n        }\n        // TODO: make a decision if the car should offer or not\n        this.offering = true\n        const c = await this.community\n        await c.playTransactions(this.tree, [setDataTransaction(\"_decentracar/offering\", Buffer.from(env.getFrom_asU8()).toString())])\n        log(this.name, \" offering a ride\")\n\n        this.messenger.publish(Buffer.from(env.getFrom_asU8()).toString(), serialize({\n            type: messageType.offer,\n            driverDid: this.id,\n            driverLocation: [this.location.x, this.location.y],\n        } as offer))\n    }\n\n    async handleSelfMessages(env: Envelope) {\n        if (this.messenger === undefined || this.tree === undefined || this.id === undefined) {\n            throw new Error(\"need an id, tree and messenger to handleSelfMessages\")\n        }\n        const msg: dcMessage = deserialize(env.getPayload_asU8())\n        switch (msg.type) {\n            case messageType.didRegistration:\n                this.registered = true // for now, for real we'd have to check this\n                log(this.name, \" registered\")\n                break;\n            case messageType.offerReject:\n                // log(this.name, \" offer rejected by rider\")\n                // TODO: check if this is a valid offer, and was sent by us and we still care about it\n                this.riderLocation = undefined\n                this.acceptedRider = undefined\n                this.offering = false\n                break;\n            case messageType.offerAccept:\n                const typedMsg = msg as offerAccept\n                log(this.name, \" offer accepted by rider\")\n                //TODO: check if this is a valid accept\n                this.acceptedRider = typedMsg.riderDid\n                this.riderLocation = new Vector(typedMsg.location[0], typedMsg.location[1])\n                this.destination = new Vector(typedMsg.destination[0], typedMsg.destination[1])\n                const c = await this.community\n                this.syncher.send(()=> {\n                    if (this.tree === undefined) {\n                        throw new Error(\"undefined tree\")\n                    }\n                    c.playTransactions(this.tree, [setDataTransaction(\"/_decentracar/accepted\", typedMsg.riderDid)])\n                })\n                break;\n        }\n    }\n\n    async tick() {\n        await this.start()\n        // do all the calculations\n        if (this.riderLocation !== undefined && !this.hasRider) {\n            let d = this.riderLocation.dist(this.location);\n            if (d < ARRIVAL_DIST) {\n                log(this.name, \" arrived at passenger\")\n                this.hasRider = true\n            }\n            // log(this.name, \" moving to rider @ \", this.riderLocation, \" (distance: \", d, \")\")\n            this.follow(this.riderLocation, ARRIVAL_DIST) //TODO: not sure what the arrival number should be\n        } else if (this.hasRider && this.destination) {\n            if (!this.acceptedRider || !this.messenger) {\n                throw new Error(\"error must have accepted rider if dropping someone off\")\n            }\n            let d = this.destination.dist(this.location);\n            // log(this.name, \" driving rider to \", this.destination, \" (distance: \", d, \")\")\n            if (d < ARRIVAL_DIST) {\n                log(this.name, \" arrived at destination\")\n                this.hasRider = false\n                this.riderLocation = undefined\n                const c = await this.community\n                await this.syncher.send(()=> {\n                    if (this.tree === undefined) {\n                        throw new Error(\"undefined tree\")\n                    }\n                    return c.playTransactions(this.tree, [\n                        setDataTransaction(\"/_decentracar/offering\", null),\n                        setDataTransaction(\"/_decentracar/accepted\", null),\n                    ])\n                })\n                this.messenger.publish(this.acceptedRider, serialize({\n                    type: messageType.dropoff,\n                    driverDid: this.id,\n                } as dropoff))\n\n                this.acceptedRider = undefined\n                this.offering = false\n\n                this.wander()\n            } else {\n                this.messenger.publish(this.acceptedRider, serialize({\n                    type: messageType.riding,\n                    driverDid: this.id,\n                    location: [this.location.x, this.location.y],\n                } as riding))\n                this.follow(this.destination, ARRIVAL_DIST) //TODO: not sure what the arrival number should be\n            }\n           \n\n        } else {\n            this.emit('wandering')\n            this.wander() // for now just wander\n        }\n\n        this.update()\n    }\n\n    wander() {\n        if (Math.random() < .05) {\n            this.wandering.rotate(Math.PI * 2 * Math.random());\n        }\n        // log(this.name, \" wandering @ \", this.location)\n        this.velocity.add(this.wandering);\n    }\n\n    follow(target: Vector, arrive: number) {\n        var dest = target.copy().sub(this.location);\n        var d = target.dist(this.location);\n\n        if (d < arrive) {\n            dest.setMag(d / arrive * MAX_SPEED);\n        } else {\n            dest.setMag(MAX_SPEED);\n        }\n\n        \n\n        this.applyForce(dest.limit(MAX_FORCE * 2));\n    }\n\n    // boundaries() {\n    //     if (this.location.x < minLong)\n    //         this.applyForce(new Vector(MAX_FORCE * 3, 0));\n\n    //     if (this.location.x > maxLong)\n    //         this.applyForce(new Vector(MAX_FORCE * 3, 0));\n\n    //     if (this.location.y < minLat)\n    //         this.applyForce(new Vector(0, MAX_FORCE * 3));\n\n    //     if (this.location.y > maxLat)\n    //         this.applyForce(new Vector(0, -MAX_FORCE * 3));\n    // }\n\n    applyForce(f: Vector) {\n        this.acceleration.add(f);\n    }\n\n    update() {\n        this.velocity.add(this.acceleration);\n        this.velocity.limit(MAX_SPEED);\n        if (this.velocity.mag() < MIN_SPEED) {\n            this.velocity.setMag(MIN_SPEED);\n        }\n        this.location.add(this.velocity);\n\n        // reset acceleration\n        this.acceleration.mul(0);\n    }\n}","import { Community, EcdsaKey, ChainTree, CID, CommunityMessenger, setDataTransaction } from \"tupelo-wasm-sdk\";\nimport { Envelope } from \"tupelo-messages\";\nimport { messageType, didRegistration, deserialize, serialize } from \"../messages\";\nimport { EventEmitter } from \"events\";\nimport { certificationTopic } from '../messages'\nimport { SimpleSyncher } from \"../util/actor\";\nimport {emittingLogger} from '../util/emittinglogger';\n\nconst log = emittingLogger(\"decentracar:company\")\n\ninterface IDecentraCarServiceOptions {\n    community: Community\n    key: EcdsaKey\n    did: string\n}\n\n/**\n * The DecentraCarService listens to the certification topic and certifies that a rider/driver is actually\n * part of the community. This is a demo so it just auto certifies anyone that asks, but in a realworld situation\n * this would be an offline process that verifies identity, etc.\n */\nexport class DecentraCarService extends EventEmitter {\n    community: Community\n    key: EcdsaKey\n    tree?: ChainTree\n    private did: string\n    private messenger?: CommunityMessenger\n    private syncher: SimpleSyncher\n\n    constructor(opts: IDecentraCarServiceOptions) {\n        super()\n        this.community = opts.community\n        this.key = opts.key\n        this.did = opts.did\n        this.syncher = new SimpleSyncher(\"company: \")\n    }\n\n    async start() {\n        await this._findOrCreateTree()\n        this.messenger = new CommunityMessenger(\"integrationtest\", 32, this.key, (await this.id()), this.community.node.pubsub)\n        return this.messenger.subscribe(certificationTopic, this.handleRegistration.bind(this))\n    }\n\n    private async handleRegistration(env: Envelope) {\n        if (this.tree === undefined || this.messenger === undefined) {\n            throw new Error(\"handling a message on a service without a tree or messenger\")\n        }\n        const msg: didRegistration = deserialize(env.getPayload_asU8())\n        const did = msg.did\n\n        let tryCount = 0\n\n        const getTip = async ()=> {\n            let tip\n\n            try {\n                tip = await this.community.getTip(did)\n            } catch (err) {\n                if (tryCount < 10 && err === 'not found') {\n                    tryCount++\n                    setTimeout(getTip, 1000)\n                    return\n                }\n                log(err, \"/ no tip found for \", did)\n                return\n            }\n            this.handleNew(tip, msg)\n        }\n        getTip()\n    }\n\n    private async handleNew(tip:any, msg:didRegistration) {\n        if (this.tree === undefined || this.messenger === undefined) {\n            throw new Error(\"handling a message on a service without a tree or messenger\")\n        }\n        \n        const did = msg.did\n        let tree = new ChainTree({\n            tip: new CID(tip),\n            store: this.community.blockservice,\n        })\n        let type = await tree.resolveData(\"_decentracar/type\")\n        switch (type.value as string) {\n            case \"rider\":\n                await this.syncher.send(() => {\n                    if (this.tree === undefined) {\n                        throw new Error(\"tree must be defined\")\n                    }\n                    return this.community.playTransactions(this.tree, [setDataTransaction(\"/_decentracar/validatedriders/\" + did, true)])\n                })\n                log(\"registered new rider: \", did)\n                this.messenger.publish(did, serialize({ type: messageType.didRegistration, did: did } as didRegistration))\n                this.emit('rider', did)\n                break;\n            case \"driver\":\n                await this.syncher.send(async () => {\n                    if (this.tree === undefined) {\n                        throw new Error(\"tree must be defined\")\n                    }\n                    await this.community.playTransactions(this.tree, [setDataTransaction(\"/_decentracar/validateddrivers/\" + did, true)])\n                    return\n                })\n                log(\"registered new driver: \", did)\n                this.messenger.publish(did, serialize({ type: messageType.didRegistration, did: did } as didRegistration))\n                this.emit('driver', did)\n                break;\n            default:\n                log(\"unknown message type: \", type.value)\n        }\n    }\n\n    private async id(): Promise<Uint8Array> {\n        if (this.tree === undefined) {\n            throw new Error(\"no tree\")\n        }\n        const id = await this.tree.id()\n        if (id === null) {\n            throw new Error(\"no id\")\n        }\n        return Buffer.from(id, 'utf8')\n    }\n\n    private async _findOrCreateTree() {\n        let tip\n        try {\n            tip = await this.community.getTip(this.did)\n        } catch (e) {\n            if (e === \"not found\") {\n                // do nothing\n            }\n        }\n        if (CID.isCID(tip)) {\n            this.tree = new ChainTree({\n                key: this.key,\n                tip: tip,\n                store: this.community.blockservice,\n            })\n        } else {\n            this.tree = await ChainTree.newEmptyTree(this.community.blockservice, this.key)\n        }\n    }\n\n}","import { Community, ChainTree, EcdsaKey, CommunityMessenger, setDataTransaction } from \"tupelo-wasm-sdk\";\nimport Vector from \"../util/vector\";\nimport { EventEmitter } from \"events\";\nimport faker from 'faker';\nimport { ridersTopic, certificationTopic, messageType, offer, riding, deserialize, serialize, didRegistration, offerReject, offerAccept, rideRequest, dcMessage } from \"../messages\";\nimport { Envelope } from \"tupelo-messages\";\nimport { SimpleSyncher } from \"../util/actor\";\nimport { randomGeo } from \"../util/locations\";\nimport {emittingLogger} from \"../util/emittinglogger\";\n\nconst log = emittingLogger('decentracar:rider')\n\n\ninterface IRiderOpts {\n    community: Promise<Community>\n    location: Vector\n}\n\nexport class Rider extends EventEmitter {\n    community: Promise<Community>\n    tree?: ChainTree\n    key?: EcdsaKey\n    id?: string\n    name: string\n    location: Vector\n    destination: Vector\n    registered: boolean\n    tickCount: number\n    stopped:boolean\n\n    acceptedDriver?: string // a DID\n\n    private startPromise?: Promise<Rider>\n    private messenger?: CommunityMessenger\n    private syncher:SimpleSyncher\n    private offers:offer[]\n    private subFn:Function\n    private firstOfferTick:number\n\n    constructor(opts: IRiderOpts) {\n        super();\n        this.community = opts.community;\n        this.location = opts.location;\n        this.destination = randomGeo(this.location, 10000) // anywhere within a 10km radius\n        this.name = faker.name.findName();\n        this.registered = false;\n        this.syncher = new SimpleSyncher();\n        this.offers = []\n        this.handleSelfMessages = this.handleSelfMessages.bind(this)\n        this.subFn = ()=>{}\n        this.tickCount = 0\n        this.firstOfferTick = 0\n        this.stopped = false\n    }\n\n    start() {\n        if (this.startPromise !== undefined) {\n            return this.startPromise\n        }\n        this.startPromise = new Promise(async (resolve, reject) => {\n            const community = await this.community\n            this.key = await EcdsaKey.generate()\n            this.tree = await ChainTree.newEmptyTree(community.blockservice, this.key)\n            const id = await this.tree.id()\n            if (id === null) {\n                reject(new Error(\"error getting id\"))\n                return\n            }\n            this.id = id\n            this.messenger = new CommunityMessenger(\"integrationtest\", 32, this.key, Buffer.from(this.id, 'utf8'), community.node.pubsub)\n            this.messenger.subscribe(this.id, this.handleSelfMessages)\n            await this.registerAsRider()\n            resolve(this)\n        })\n        return this.startPromise\n    }\n\n    stop() {\n        log(this.name, \" dropped off\")\n        if (this.messenger !== undefined && this.id !== undefined) {\n            this.messenger.unsubscribe(this.id, this.handleSelfMessages)\n        }\n        this.emit('stopped')\n        this.stopped = true\n    }\n\n    async registerAsRider() {\n        log(this.name, \" registering\")\n        if (this.messenger === undefined || this.tree === undefined) {\n            throw new Error(\"need a tree and messenger to registerAsDriver\")\n        }\n        const c = await this.community\n        await this.syncher.send(()=> {\n            if (this.tree === undefined) {\n                throw new Error(\"undefined tree\")\n            }\n            log(this.name, \" set type to rider\")\n            return c.playTransactions(this.tree, [setDataTransaction(\"_decentracar/type\", \"rider\")])\n        })\n        await c.nextUpdate()\n        log(this.name, \" publishing did registration\")\n        this.messenger.publish(certificationTopic, serialize({\n            type: messageType.didRegistration,\n            did: this.id,\n        } as didRegistration))\n    }\n\n    // the drivers should send messages directly here\n    async handleSelfMessages(env: Envelope) {\n        const msg: dcMessage = deserialize(env.getPayload_asU8())\n        switch (msg.type) {\n            case messageType.didRegistration:\n                this.registered = true // for now, for real we'd have to check this\n                log(this.name, \" registered\")\n                this.askForRide()\n                break;\n            case messageType.offer:\n                this.possiblyAcceptRide(msg as offer)\n                break;\n            case messageType.riding:\n                const typedMsg = msg as riding\n                this.location = new Vector(typedMsg.location[0], typedMsg.location[1])\n                break;\n            case messageType.dropoff:\n                this.stop()\n                break;\n        }\n    }\n\n    possiblyAcceptRide(msg: offer) {\n        if (this.acceptedDriver !== undefined) {\n            this.rejectRide(msg)\n            return\n        }\n\n        this.offers.push(msg)\n\n        if (this.offers.length === 1) {\n            // after the first offer, we'll wait a tick and then calculate which rider to accept\n            this.once('tick', ()=> {\n                let closest:offer|undefined = undefined\n                let closestDist:number = -1\n                for (let offer of this.offers) {\n                    let d = this.location.dist(new Vector(offer.driverLocation[0], offer.driverLocation[1]))\n                    if (closestDist === -1 || d < closestDist) {\n                        closest = offer\n                        closestDist = d\n                    }\n                }\n\n                if (closest === undefined) {\n                    throw new Error(\"no closest offer, this state should never happen, but in the loop\")\n                }\n\n                // otherwise accept this driver\n                this.acceptRide(closest)\n            })\n        }\n    }\n\n    async rejectRide(rideOffer:offer) {\n        if (this.messenger === undefined) {\n            throw new Error(\"must have a messenger and an id\")\n        }\n        // log(this.name, \" rejecting rider \", rideOffer.driverDid)\n        this.messenger.publish(rideOffer.driverDid, serialize({\n            type: messageType.offerReject,\n            offer: rideOffer,\n        } as offerReject))\n    }\n\n    async acceptRide(msg:offer) {\n        if (this.messenger === undefined || this.id == null) {\n            throw new Error(\"must have a messenger and an id\")\n        }\n        log(this.name, \" acceppting ride from: \", msg.driverDid)\n        // TODO: there should be a lot more rules and validation here :)\n        this.acceptedDriver = msg.driverDid\n        const c = await this.community\n        await this.syncher.send(() => {\n            if (this.tree === undefined) {\n                throw new Error(\"undefined tree\")\n            }\n            return c.playTransactions(this.tree, [setDataTransaction(\"/_decentracar/accepted\", msg.driverDid)])\n        })\n        this.messenger.publish(msg.driverDid, serialize({\n            type: messageType.offerAccept,\n            riderDid: this.id,\n            location: [this.location.x, this.location.y],\n            destination: [this.destination.x, this.destination.y]\n        } as offerAccept))\n        \n        for (let offer of this.offers) {\n            if (offer !== msg) {\n                this.rejectRide(offer)\n            }\n        }\n        this.offers = []\n    }\n\n    tick() {\n        this.tickCount++\n        this.emit('tick', this.tickCount)\n    }\n\n    async askForRide() {\n        if (this.messenger === undefined || this.id == null) {\n            throw new Error(\"must have a messenger and an id\")\n        }\n        log(this.name, \" asking for ride\")\n\n        this.messenger.publish(ridersTopic, serialize({\n            type: messageType.rideRequest,\n            riderDID: this.id,\n            location: [this.location.x, this.location.y]\n        } as rideRequest))\n    }\n}","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = function() { return []; };\nwebpackEmptyContext.resolve = webpackEmptyContext;\nmodule.exports = webpackEmptyContext;\nwebpackEmptyContext.id = 528;","export class Vector {\n    x:number\n    y:number\n    constructor(x:number,y:number) {\n        this.x = x;\n        this.y = y;\n    }\n\n  set(x:number, y:number)\n\t{\n\t\tthis.x = x;\n\t\tthis.y = y;\n\n        return this;\n        \n    }\n    \n  add(v:Vector)\n\t{\n\t\tthis.x += v.x;\n\t\tthis.y += v.y;\n\n\t\treturn this;\n    }\n    \n  sub(v:Vector)\n\t{\n\t\tthis.x -= v.x;\n\t\tthis.y -= v.y;\n\n\t\treturn this;\n    }\n    \n  mul(s:number)\n\t{\n\t\tthis.x *= s;\n\t\tthis.y *= s;\n\n\t\treturn this;\n    }\n    \n  div(s:number)\n\t{\n\t\t!s && console.log(\"Division by zero!\");\n\n\t\tthis.x /= s;\n\t\tthis.y /= s;\n\n\t\treturn this;\n    }\n    \n  mag(){\n\t\treturn Math.sqrt(this.x * this.x + this.y * this.y);\n    }\n    \n  normalize()\n\t{\n\t\tvar mag = this.mag();\n\t\tmag && this.div(mag);\n\t\treturn this;\n    }\n    \n  angle()\n\t{\n\t\treturn Math.atan2(this.y, this.x);\n    }\n    \n  setMag(m:number)\n\t{\n\t\tvar angle = this.angle();\n\t\tthis.x = m * Math.cos(angle);\n\t\tthis.y = m * Math.sin(angle);\n\t\treturn this;\n    }\n    \n  setAngle(a:number)\n\t{\n\t\tvar mag = this.mag();\n\t\tthis.x = mag * Math.cos(a);\n\t\tthis.y = mag * Math.sin(a);\n\t\treturn this;\n    }\n    \n  rotate(a:number)\n\t{\n\t\tthis.setAngle(this.angle() + a);\n\t\treturn this;\n    }\n    \n  limit(l:number)\n\t{\n\t\tvar mag = this.mag();\n\t\tif(mag > l)\n\t\t\tthis.setMag(l);\n\t\treturn this;\n    }\n    \n  angleBetween(v:Vector)\n\t{\n\t\treturn this.angle() - v.angle();\n    }\n    \n  dot(v:Vector)\n\t{\n\t\treturn this.x * v.x + this.y * v.y;\n    }\n    \n  lerp(v:Vector, amt:number)\n\t{\n\t\tthis.x += (v.x - this.x) * amt;\n\t\tthis.y += (v.y - this.y) * amt;\n\t\treturn this;\n    }\n    \n  dist(v:Vector)\n\t{\n\t\tvar dx = this.x - v.x;\n\t\tvar dy = this.y - v.y;\n\t\treturn Math.sqrt(dx * dx + dy * dy);\n    }\n    \n  copy()\n\t{\n\t\treturn new Vector(this.x, this.y);\n\t}\n}\n\n\nexport default Vector","import debug from 'debug'\nimport { EventEmitter } from 'events'\n\nexport const logs = new EventEmitter()\n\nclass EmittingLogger {\n    private debugger:Function\n    private name:string\n\n    constructor(name:string) {\n        this.name = name\n        this.debugger = debug(name)\n        this.log = this.log.bind(this)\n    }\n\n    log(...args: any[]) {\n        logs.emit(this.name, ...args)\n        this.debugger(...args)\n    }\n    \n}\n\nexport function emittingLogger(name:string):Function {\n    return new EmittingLogger(name).log\n}","import Vector from './vector'\n\n// lon/Lat (not lat,long) maps to x,y\nexport const mapCenter = new Vector(13.362029, 52.491362) // Berlin longitude,latitude\n\nexport const maxLat = 53.4\nexport const minLat = 51.5\nexport const maxLong = 14.3\nexport const minLong = 12.4\n\n// see https://stackoverflow.com/questions/31192451/generate-random-geo-coordinates-within-specific-radius-from-seed-point\nexport function randomGeo(center:Vector, radius:number):Vector {\n    var y0 = center.y;\n    var x0 = center.x;\n    var rd = radius / 111300;\n\n    var u = Math.random();\n    var v = Math.random();\n\n    var w = rd * Math.sqrt(u);\n    var t = 2 * Math.PI * v;\n    var x = w * Math.cos(t);\n    var y = w * Math.sin(t);\n\n    return new Vector(x+x0, y+y0)\n}\n\n// see https://stackoverflow.com/questions/31192451/generate-random-geo-coordinates-within-specific-radius-from-seed-point\nexport function distance(lat1:number, lon1:number, lat2:number, lon2:number) {\n    var R = 6371000;\n    var a = 0.5 - Math.cos((lat2 - lat1) * Math.PI / 180) / 2 + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * (1 - Math.cos((lon2 - lon1) * Math.PI / 180)) / 2;\n    return R * 2 * Math.asin(Math.sqrt(a));\n}\n"],"sourceRoot":""}