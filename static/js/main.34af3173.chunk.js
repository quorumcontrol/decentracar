(window.webpackJsonpdecentracar=window.webpackJsonpdecentracar||[]).push([[0],{103:function(e,t,r){"use strict";r.d(t,"a",function(){return d});var n=r(3),i=r.n(n),a=r(16),s=r(38),c=r(36),o=r(6),u=r.n(o)()("util:syncher"),d=function(){function e(t){Object(s.a)(this,e),this.queue=void 0,this.started=void 0,this.name=void 0,this.started=!1,this.queue=[],this.name=t}return Object(c.a)(e,[{key:"run",value:function(){var e=Object(a.a)(i.a.mark(function e(){var t,r;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==(t=this.queue.pop())){e.next=5;break}return u(this.name," stopping syncher"),this.started=!1,e.abrupt("return");case 5:return e.prev=5,u(this.name," run fn",t.fn.toString()),e.next=9,t.fn();case 9:r=e.sent,u(this.name," finish fn"),t.res(r),e.next=18;break;case 14:e.prev=14,e.t0=e.catch(5),u(this.name," rejecting: ",e.t0),t.rej(e.t0);case 18:this.queue.length>0?(u(this.name,"syncher queueing another"),this.run()):this.started=!1;case 19:case"end":return e.stop()}},e,this,[[5,14]])}));return function(){return e.apply(this,arguments)}}()},{key:"send",value:function(e){var t=this;return new Promise(function(r,n){if(t.queue.push({fn:e,res:r,rej:n}),!t.started)return u(t.name," not started, starting"),t.started=!0,void t.run();u(t.name," run already started")})}}]),e}()},11:function(e,t,r){"use strict";r.d(t,"a",function(){return s}),r.d(t,"d",function(){return c}),r.d(t,"c",function(){return n}),r.d(t,"e",function(){return o}),r.d(t,"b",function(){return u});var n,i=r(133),a=r.n(i),s="decentracar-certifications",c="decentracar-riders";function o(e){return a.a.util.serialize(e)}function u(e){return a.a.util.deserialize(e)}!function(e){e[e.offer=0]="offer",e[e.offerReject=1]="offerReject",e[e.offerAccept=2]="offerAccept",e[e.didRegistration=3]="didRegistration",e[e.rideRequest=4]="rideRequest",e[e.rideRequestResponse=5]="rideRequestResponse",e[e.riding=6]="riding",e[e.dropoff=7]="dropoff"}(n||(n={}))},1101:function(e,t){},1103:function(e,t){},220:function(e,t){},2226:function(e,t,r){e.exports=r.p+"static/media/driver.511e2960.png"},2227:function(e,t,r){e.exports=r.p+"static/media/rider.23486b95.png"},2230:function(e,t,r){"use strict";r.r(t);var n,i=r(5),a=r.n(i),s=r(132),c=r.n(s),o=(r(499),r(3)),u=r.n(o),d=r(16),h=r(25),f=(r(501),r(502),r(2233)),l=r(2234),v=r(2235),p=r(2237),m=r(2238),b=r(2236),y=r(17),g=r(6),k=r.n(g),w=k()("appcommunity"),x='\nid = "tupelolocal"\nBootstrapAddresses = [\n    "/ip4/127.0.0.1/tcp/34001/ipfs/16Uiu2HAm3TGSEKEjagcCojSJeaT5rypaeJMKejijvYSnAjviWwV5",\n    "/ip4/127.0.0.1/tcp/50000/ws/ipfs/16Uiu2HAm4hjC7zZTSN5KAp187vn52bZMsC8VaVdtrci7HD4aZcU7",\n]\n[[signers]]\nVerKeyHex = "0x15796b266a7d6b7c6b29c5bf97ad376fe8457e4d56bb0612ec8703c65ca7b6bb5dca004d55f5238d7764cd100c9e9cac3c5abce902bae8a5f9c29de716a145595b071b1b7038a48b4f6f88e7664b38c02062f64b3ceb499e4cbb82361457dcd731f5b48901871e7fd56a9c91ab3e06d3f7cb27288962686d9a05e02c1482f01f"\nDestKeyHex = "0x04f6dee3f7da1da58afd6ee58ea6b858fb67664fc6e2240bb6e3a75c0e1db9bbef5f413c8604bb864513d3cf27eca60b539b048b2a08f8799570c14dfb73f3f391"\n\n[[signers]]\nVerKeyHex = "0x7be8c92c8c295ef3e97be28f469f5f94d10ee7db4d202776bee5cf55c62d508a0c3550a19342d768ff073c0798ce003646df586ef588a9e9443a0ca86a234ed15150dc98ecc3f1071649fca03426f1c8c215a90752f51faa3e2e788e1dae2e9e5cf87c1ca4239a0949a0ba6ea09c061a538372cc4230dedafae929b170ad7704"\nDestKeyHex = "0x0438b196bddb9c3ec395b8ccb07bdab44ec768c084e7141b09ac5638d47fffbd5e7b7623f499a2e714e31464a356a0e30ad7c93045b6cd9957b45e957cc15dcb99"\n\n[[signers]]\nVerKeyHex = "0x88aefad94805db01cacaf190f47bc9e40f584b5085c651da168ac4034d570b4750bf7b23803d204e483e407a5ca34ee7f7a434733346451cf3f5d26c0d11e5ac45398a03fbba2d3b0dfc21cdf14615430cea394bd9423d8527eaa82a96aa6d20655724d99770ee3488b6537d6be143b84b21ad5ee12c190048757fe453313fd2"\nDestKeyHex = "0x0468924bd1341b5cec1fed888aaf1e3caa94e7d0f13d4f4573b01b296374b9e710a58a7b40e7161c0bcf7fd41832441ca21076f3846e854c8d8c640f2469a552b1"\n';var j=r(38),O=r(36),E=r(65),R=r(55),C=r(64),D=r(490),M=r(86),T=r(10),S=r(491),A=r(492),P=k()("decentracar:simulation"),_=function(e){function t(e){var r;Object(j.a)(this,t),(r=Object(E.a)(this,Object(R.a)(t).call(this))).drivers=void 0,r.riders=void 0,r.interval=void 0,r.community=void 0,r.tickCount=void 0,r.riderProbability=void 0,r.tickCount=0,r.community=e.community;for(var n=[],i=0;i<e.driverCount;i++)n[i]=new D.a({community:e.community,location:Object(M.b)(M.a,5e3)});return r.riderProbability=e.riderProbability,r.drivers=n,r.riders=[],r}return Object(C.a)(t,e),Object(O.a)(t,[{key:"stop",value:function(){P("simulation stopped"),void 0!==this.interval&&clearInterval(this.interval)}},{key:"start",value:function(){var e=Object(d.a)(u.a.mark(function e(){var t,r,n,i,a,s,c,o,d,h;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return P("starting simulation"),e.next=3,this.community;case 3:return t=e.sent,e.next=6,y.EcdsaKey.generate();case 6:return r=e.sent,e.next=9,y.ChainTree.newEmptyTree(t.blockservice,r);case 9:return n=e.sent,e.next=12,n.id();case 12:if(null!==(i=e.sent)){e.next=15;break}throw new Error("unknown tree id");case 15:return a=new S.a({community:t,key:r,did:i}),e.next=18,a.start();case 18:for(s=!0,c=!1,o=void 0,e.prev=21,d=this.drivers[Symbol.iterator]();!(s=(h=d.next()).done);s=!0)h.value.start();e.next=29;break;case 25:e.prev=25,e.t0=e.catch(21),c=!0,o=e.t0;case 29:e.prev=29,e.prev=30,s||null==d.return||d.return();case 32:if(e.prev=32,!c){e.next=35;break}throw o;case 35:return e.finish(32);case 36:return e.finish(29);case 37:case"end":return e.stop()}},e,this,[[21,25,29,37],[30,,32,36]])}));return function(){return e.apply(this,arguments)}}()},{key:"tick",value:function(){var e=Object(d.a)(u.a.mark(function e(){var t,r,n,i,a,s,c,o,d,h;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:for(t=!0,r=!1,n=void 0,e.prev=3,i=this.drivers[Symbol.iterator]();!(t=(a=i.next()).done);t=!0)a.value.tick();e.next=11;break;case 7:e.prev=7,e.t0=e.catch(3),r=!0,n=e.t0;case 11:e.prev=11,e.prev=12,t||null==i.return||i.return();case 14:if(e.prev=14,!r){e.next=17;break}throw n;case 17:return e.finish(14);case 18:return e.finish(11);case 19:for(this.possiblyCreateRider(),s=!0,c=!1,o=void 0,e.prev=23,d=this.riders[Symbol.iterator]();!(s=(h=d.next()).done);s=!0)h.value.tick();e.next=31;break;case 27:e.prev=27,e.t1=e.catch(23),c=!0,o=e.t1;case 31:e.prev=31,e.prev=32,s||null==d.return||d.return();case 34:if(e.prev=34,!c){e.next=37;break}throw o;case 37:return e.finish(34);case 38:return e.finish(31);case 39:this.tickCount++,this.emit("tick",this.tickCount);case 41:case"end":return e.stop()}},e,this,[[3,7,11,19],[12,,14,18],[23,27,31,39],[32,,34,38]])}));return function(){return e.apply(this,arguments)}}()},{key:"possiblyCreateRider",value:function(){var e=Object(d.a)(u.a.mark(function e(){var t,r=this;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this.tickCount<5)){e.next=2;break}return e.abrupt("return");case 2:100*Math.random()<this.riderProbability&&((t=new A.a({community:this.community,location:Object(M.b)(M.a,5e3)})).start(),t.once("stopped",function(){var e=r.riders.indexOf(t);r.riders.splice(e,1)}),this.riders.push(t));case 3:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"tickEvery",value:function(){var e=Object(d.a)(u.a.mark(function e(t){var r=this;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:setInterval(function(){r.tick()},t);case 1:case"end":return e.stop()}},e)}));return function(t){return e.apply(this,arguments)}}()}]),t}(T.EventEmitter),q=r(26),I=r(39),U=r(70),N=window.location.pathname;console.log("subDirectory ",N),"/"!==N&&(console.log("setting wasmpath to: ",N+"tupelo.wasm"),Go.setWasmPath(N+"tupelo.wasm"));var z=[52.491362,13.362029],K=r(2226),L=r(2227),B=new q.Icon({iconUrl:K,iconRetinaUrl:K,iconSize:new q.Point(30,30),className:"leaflet-div-icon"}),F=new q.Icon({iconUrl:L,iconRetinaUrl:L,iconSize:new q.Point(30,30),className:"leaflet-div-icon"}),H=function(e){var t=e.driver;return a.a.createElement(f.a,{position:[t.location.y,t.location.x],icon:B},a.a.createElement(l.a,null,"A Driver: ",t.name,"Accepted Rider: ",t.acceptedRider),a.a.createElement(v.a,null,t.name))},V=function(e){var t=e.rider;return a.a.createElement(f.a,{position:[t.location.y,t.location.x],icon:F},a.a.createElement(l.a,null,"A Rider: ",t.name),a.a.createElement(v.a,null,t.name))},G=function(e){var t=e.simulation,r=e.logs,n=[],i=!0,s=!1,c=void 0;try{for(var o,u=t.drivers[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var d=o.value;n.push(a.a.createElement(H,{key:d.name,driver:d}))}}catch(k){s=!0,c=k}finally{try{i||null==u.return||u.return()}finally{if(s)throw c}}var h=!0,f=!1,l=void 0;try{for(var v,y=t.riders[Symbol.iterator]();!(h=(v=y.next()).done);h=!0){var g=v.value;n.push(a.a.createElement(V,{key:g.name,rider:g}))}}catch(k){f=!0,l=k}finally{try{h||null==y.return||y.return()}finally{if(f)throw l}}return a.a.createElement(I.Columns,null,a.a.createElement(I.Columns.Column,{size:"half"},a.a.createElement(p.a,{zoom:12,center:z},a.a.createElement(m.a,{url:"https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",attribution:'\xa9 <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'}),a.a.createElement(b.a,null,n))),a.a.createElement(I.Columns.Column,null,a.a.createElement(I.Content,{className:"app-logs"},a.a.createElement("h2",null,"Events"),a.a.createElement("div",null,r))))},J=function(e){var t=e.txt,r=e.icon;return a.a.createElement(I.Box,{key:t},a.a.createElement(I.Media,null,a.a.createElement(I.Media.Item,null,a.a.createElement(I.Image,{size:32,src:r})),a.a.createElement(I.Media.Item,null,a.a.createElement(I.Content,null,a.a.createElement("p",null,t)))))},W=function(){var e=Object(i.useState)(null),t=Object(h.a)(e,2),r=t[0],s=t[1],c=Object(i.useState)([]),o=Object(h.a)(c,2),f=o[0],l=o[1],v=Object(i.useState)(0),p=Object(h.a)(v,2),m=p[0],b=p[1],g=function(){var e=Object(d.a)(u.a.mark(function e(){var t;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:(t=new _({community:(w("getAppCommunity"),void 0!==n?n:n=new Promise(function(){var e=Object(d.a)(u.a.mark(function e(t,r){var n;return u.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:e.t0="production",e.next="production"===e.t0?3:8;break;case 3:return w("using production community"),e.next=6,y.Community.getDefault();case 6:return n=e.sent,e.abrupt("break",13);case 8:return w("using development community"),e.next=11,y.Community.fromNotaryGroupToml(x);case 11:n=e.sent,y.Community.setDefault(n);case 13:t(n);case 14:case"end":return e.stop()}},e)}));return function(t,r){return e.apply(this,arguments)}}())),driverCount:10,riderProbability:5})).on("tick",function(e){b(e)}),t.start(),t.tickEvery(1e3),U.b.on("decentracar:driver",function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];f.unshift(a.a.createElement(J,{icon:K,txt:t.join(" ")})),l(f)}),U.b.on("decentracar:rider",function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];f.unshift(a.a.createElement(J,{icon:L,txt:t.join(" ")})),l(f)}),s(t);case 7:case"end":return e.stop()}},e)}));return function(){return e.apply(this,arguments)}}();return a.a.createElement("div",null,a.a.createElement(I.Container,null,a.a.createElement(I.Navbar,null,a.a.createElement(I.Navbar.Item,null,"Decentracar Simulation"),a.a.createElement(I.Navbar.Item,null,"tick: ",m)),r?a.a.createElement(G,{simulation:r,logs:f}):a.a.createElement(I.Content,null,a.a.createElement("p",null,"This is a simulation of a simplified decentralized car sharing app."),a.a.createElement("p",null,"You can read more about it here: ",a.a.createElement("a",{href:"https://www.tupelo.org/posts/decentracar"},"https://www.tupelo.org/posts/decentracar"),". Github repo is here: ",a.a.createElement("a",{href:"https://github.com/quorumcontrol/decentracar"},"https://github.com/quorumcontrol/decentracar")),a.a.createElement("p",null,a.a.createElement(I.Button,{onClick:g},"Click here to start")),a.a.createElement("p",null,"This simulation only works on desktop browsers (and not safari)."))))};Boolean("localhost"===window.location.hostname||"[::1]"===window.location.hostname||window.location.hostname.match(/^127(?:\.(?:25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)){3}$/));c.a.render(a.a.createElement(W,null),document.getElementById("root")),"serviceWorker"in navigator&&navigator.serviceWorker.ready.then(function(e){e.unregister()})},490:function(e,t,r){"use strict";(function(e){r.d(t,"a",function(){return k});var n=r(3),i=r.n(n),a=r(16),s=r(38),c=r(36),o=r(65),u=r(55),d=r(64),h=r(17),f=r(186),l=r.n(f),v=r(56),p=r(10),m=r(11),b=r(103),y=r(70),g=Object(y.a)("decentracar:driver"),k=function(t){function r(e){var t;return Object(s.a)(this,r),(t=Object(o.a)(this,Object(u.a)(r).call(this))).community=void 0,t.tree=void 0,t.key=void 0,t.id=void 0,t.name=void 0,t.location=void 0,t.velocity=void 0,t.acceleration=void 0,t.wandering=void 0,t.riderLocation=void 0,t.acceptedRider=void 0,t.destination=void 0,t.offering=void 0,t.hasRider=void 0,t.registered=void 0,t.messenger=void 0,t.startPromise=void 0,t.syncher=void 0,t.community=e.community,t.location=e.location,t.velocity=new v.a(0,0),t.acceleration=new v.a(0,0),t.wandering=new v.a(Math.random()/1e3,Math.random()/1e3),t.name=l.a.name.findName(),t.registered=!1,t.offering=!1,t.hasRider=!1,t.syncher=new b.a,t}return Object(d.a)(r,t),Object(c.a)(r,[{key:"start",value:function(){var t=this;return void 0!==this.startPromise?this.startPromise:(this.startPromise=new Promise(function(){var r=Object(a.a)(i.a.mark(function r(n,a){var s,c;return i.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.community;case 2:return s=r.sent,r.next=5,h.EcdsaKey.generate();case 5:return t.key=r.sent,r.next=8,h.ChainTree.newEmptyTree(s.blockservice,t.key);case 8:return t.tree=r.sent,r.next=11,t.tree.id();case 11:if(null!==(c=r.sent)){r.next=15;break}return a(new Error("error getting id")),r.abrupt("return");case 15:return t.id=c,t.messenger=new h.CommunityMessenger("integrationtest",32,t.key,e.from(t.id,"utf8"),s.node.pubsub),t.messenger.subscribe(t.id,t.handleSelfMessages.bind(t)),t.messenger.subscribe(m.d,t.handleRidersMessage.bind(t)),r.next=21,t.registerAsDriver();case 21:n(t);case 22:case"end":return r.stop()}},r)}));return function(e,t){return r.apply(this,arguments)}}()),this.startPromise)}},{key:"registerAsDriver",value:function(){var e=Object(a.a)(i.a.mark(function e(){var t;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(g(this.name," registering as driver"),void 0!==this.messenger&&void 0!==this.tree){e.next=3;break}throw new Error("need a tree and messenger to registerAsDriver");case 3:return e.next=5,this.community;case 5:return t=e.sent,e.next=8,t.playTransactions(this.tree,[Object(h.setDataTransaction)("_decentracar/type","driver")]);case 8:return e.next=10,t.nextUpdate();case 10:this.messenger.publish(m.a,Object(m.e)({type:m.c.didRegistration,did:this.id}));case 11:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"handleRidersMessage",value:function(){var t=Object(a.a)(i.a.mark(function t(r){var n;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(!this.offering){t.next=2;break}return t.abrupt("return");case 2:if(void 0!==this.messenger&&void 0!==this.tree&&void 0!==this.id){t.next=4;break}throw new Error("need an id, tree and messenger to registerAsDriver");case 4:return this.offering=!0,t.next=7,this.community;case 7:return n=t.sent,t.next=10,n.playTransactions(this.tree,[Object(h.setDataTransaction)("_decentracar/offering",e.from(r.getFrom_asU8()).toString())]);case 10:g(this.name," offering a ride"),this.messenger.publish(e.from(r.getFrom_asU8()).toString(),Object(m.e)({type:m.c.offer,driverDid:this.id,driverLocation:[this.location.x,this.location.y]}));case 12:case"end":return t.stop()}},t,this)}));return function(e){return t.apply(this,arguments)}}()},{key:"handleSelfMessages",value:function(){var e=Object(a.a)(i.a.mark(function e(t){var r,n,a,s=this;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.messenger&&void 0!==this.tree&&void 0!==this.id){e.next=2;break}throw new Error("need an id, tree and messenger to handleSelfMessages");case 2:r=Object(m.b)(t.getPayload_asU8()),e.t0=r.type,e.next=e.t0===m.c.didRegistration?6:e.t0===m.c.offerReject?9:e.t0===m.c.offerAccept?13:23;break;case 6:return this.registered=!0,g(this.name," registered"),e.abrupt("break",23);case 9:return this.riderLocation=void 0,this.acceptedRider=void 0,this.offering=!1,e.abrupt("break",23);case 13:return n=r,g(this.name," offer accepted by rider"),this.acceptedRider=n.riderDid,this.riderLocation=new v.a(n.location[0],n.location[1]),this.destination=new v.a(n.destination[0],n.destination[1]),e.next=20,this.community;case 20:return a=e.sent,this.syncher.send(function(){if(void 0===s.tree)throw new Error("undefined tree");a.playTransactions(s.tree,[Object(h.setDataTransaction)("/_decentracar/accepted",n.riderDid)])}),e.abrupt("break",23);case 23:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"tick",value:function(){var e=Object(a.a)(i.a.mark(function e(){var t,r=this;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.start();case 2:if(void 0===this.riderLocation||this.hasRider){e.next=8;break}this.riderLocation.dist(this.location)<.002&&(g(this.name," arrived at passenger"),this.hasRider=!0),this.follow(this.riderLocation,.002),e.next=33;break;case 8:if(!this.hasRider||!this.destination){e.next=31;break}if(this.acceptedRider&&this.messenger){e.next=11;break}throw new Error("error must have accepted rider if dropping someone off");case 11:if(!(this.destination.dist(this.location)<.002)){e.next=27;break}return g(this.name," arrived at destination"),this.hasRider=!1,this.riderLocation=void 0,e.next=18,this.community;case 18:return t=e.sent,e.next=21,this.syncher.send(function(){if(void 0===r.tree)throw new Error("undefined tree");return t.playTransactions(r.tree,[Object(h.setDataTransaction)("/_decentracar/offering",null),Object(h.setDataTransaction)("/_decentracar/accepted",null)])});case 21:this.messenger.publish(this.acceptedRider,Object(m.e)({type:m.c.dropoff,driverDid:this.id})),this.acceptedRider=void 0,this.offering=!1,this.wander(),e.next=29;break;case 27:this.messenger.publish(this.acceptedRider,Object(m.e)({type:m.c.riding,driverDid:this.id,location:[this.location.x,this.location.y]})),this.follow(this.destination,.002);case 29:e.next=33;break;case 31:this.emit("wandering"),this.wander();case 33:this.update();case 34:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"wander",value:function(){Math.random()<.05&&this.wandering.rotate(2*Math.PI*Math.random()),this.velocity.add(this.wandering)}},{key:"follow",value:function(e,t){var r=e.copy().sub(this.location),n=e.dist(this.location);n<t?r.setMag(n/t*.001):r.setMag(.001),this.applyForce(r.limit(2e-4))}},{key:"applyForce",value:function(e){this.acceleration.add(e)}},{key:"update",value:function(){this.velocity.add(this.acceleration),this.velocity.limit(.001),this.velocity.mag()<16e-6&&this.velocity.setMag(16e-6),this.location.add(this.velocity),this.acceleration.mul(0)}}]),r}(p.EventEmitter)}).call(this,r(0).Buffer)},491:function(e,t,r){"use strict";(function(e){r.d(t,"a",function(){return b});var n=r(3),i=r.n(n),a=r(16),s=r(38),c=r(36),o=r(65),u=r(55),d=r(64),h=r(17),f=r(11),l=r(10),v=r(103),p=r(70),m=Object(p.a)("decentracar:company"),b=function(t){function r(e){var t;return Object(s.a)(this,r),(t=Object(o.a)(this,Object(u.a)(r).call(this))).community=void 0,t.key=void 0,t.tree=void 0,t.did=void 0,t.messenger=void 0,t.syncher=void 0,t.community=e.community,t.key=e.key,t.did=e.did,t.syncher=new v.a("company: "),t}return Object(d.a)(r,t),Object(c.a)(r,[{key:"start",value:function(){var e=Object(a.a)(i.a.mark(function e(){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this._findOrCreateTree();case 2:return e.t0=h.CommunityMessenger,e.t1=this.key,e.next=6,this.id();case 6:return e.t2=e.sent,e.t3=this.community.node.pubsub,this.messenger=new e.t0("integrationtest",32,e.t1,e.t2,e.t3),e.abrupt("return",this.messenger.subscribe(f.a,this.handleRegistration.bind(this)));case 10:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"handleRegistration",value:function(){var e=Object(a.a)(i.a.mark(function e(t){var r,n,s,c,o=this;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.tree&&void 0!==this.messenger){e.next=2;break}throw new Error("handling a message on a service without a tree or messenger");case 2:r=Object(f.b)(t.getPayload_asU8()),n=r.did,s=0,(c=function(){var e=Object(a.a)(i.a.mark(function e(){var t;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,o.community.getTip(n);case 3:t=e.sent,e.next=14;break;case 6:if(e.prev=6,e.t0=e.catch(0),!(s<10&&"not found"===e.t0)){e.next=12;break}return s++,setTimeout(c,1e3),e.abrupt("return");case 12:return m(e.t0,"/ no tip found for ",n),e.abrupt("return");case 14:o.handleNew(t,r);case 15:case"end":return e.stop()}},e,null,[[0,6]])}));return function(){return e.apply(this,arguments)}}())();case 7:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"handleNew",value:function(){var e=Object(a.a)(i.a.mark(function e(t,r){var n,s,c,o=this;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.tree&&void 0!==this.messenger){e.next=2;break}throw new Error("handling a message on a service without a tree or messenger");case 2:return n=r.did,s=new h.ChainTree({tip:new h.CID(t),store:this.community.blockservice}),e.next=6,s.resolveData("_decentracar/type");case 6:c=e.sent,e.t0=c.value,e.next="rider"===e.t0?10:"driver"===e.t0?16:22;break;case 10:return e.next=12,this.syncher.send(function(){if(void 0===o.tree)throw new Error("tree must be defined");return o.community.playTransactions(o.tree,[Object(h.setDataTransaction)("/_decentracar/validatedriders/"+n,!0)])});case 12:return m("registered new rider: ",n),this.messenger.publish(n,Object(f.e)({type:f.c.didRegistration,did:n})),this.emit("rider",n),e.abrupt("break",23);case 16:return e.next=18,this.syncher.send(Object(a.a)(i.a.mark(function e(){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==o.tree){e.next=2;break}throw new Error("tree must be defined");case 2:return e.next=4,o.community.playTransactions(o.tree,[Object(h.setDataTransaction)("/_decentracar/validateddrivers/"+n,!0)]);case 4:return e.abrupt("return");case 5:case"end":return e.stop()}},e)})));case 18:return m("registered new driver: ",n),this.messenger.publish(n,Object(f.e)({type:f.c.didRegistration,did:n})),this.emit("driver",n),e.abrupt("break",23);case 22:m("unknown message type: ",c.value);case 23:case"end":return e.stop()}},e,this)}));return function(t,r){return e.apply(this,arguments)}}()},{key:"id",value:function(){var t=Object(a.a)(i.a.mark(function t(){var r;return i.a.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(void 0!==this.tree){t.next=2;break}throw new Error("no tree");case 2:return t.next=4,this.tree.id();case 4:if(null!==(r=t.sent)){t.next=7;break}throw new Error("no id");case 7:return t.abrupt("return",e.from(r,"utf8"));case 8:case"end":return t.stop()}},t,this)}));return function(){return t.apply(this,arguments)}}()},{key:"_findOrCreateTree",value:function(){var e=Object(a.a)(i.a.mark(function e(){var t;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.community.getTip(this.did);case 3:t=e.sent,e.next=9;break;case 6:e.prev=6,e.t0=e.catch(0),e.t0;case 9:if(!h.CID.isCID(t)){e.next=13;break}this.tree=new h.ChainTree({key:this.key,tip:t,store:this.community.blockservice}),e.next=16;break;case 13:return e.next=15,h.ChainTree.newEmptyTree(this.community.blockservice,this.key);case 15:this.tree=e.sent;case 16:case"end":return e.stop()}},e,this,[[0,6]])}));return function(){return e.apply(this,arguments)}}()}]),r}(l.EventEmitter)}).call(this,r(0).Buffer)},492:function(e,t,r){"use strict";(function(e){r.d(t,"a",function(){return x});var n=r(3),i=r.n(n),a=r(16),s=r(38),c=r(36),o=r(65),u=r(55),d=r(15),h=r(64),f=r(17),l=r(56),v=r(10),p=r(186),m=r.n(p),b=r(11),y=r(103),g=r(86),k=r(70),w=Object(k.a)("decentracar:rider"),x=function(t){function r(e){var t;return Object(s.a)(this,r),(t=Object(o.a)(this,Object(u.a)(r).call(this))).community=void 0,t.tree=void 0,t.key=void 0,t.id=void 0,t.name=void 0,t.location=void 0,t.destination=void 0,t.registered=void 0,t.tickCount=void 0,t.stopped=void 0,t.acceptedDriver=void 0,t.startPromise=void 0,t.messenger=void 0,t.syncher=void 0,t.offers=void 0,t.subFn=void 0,t.firstOfferTick=void 0,t.community=e.community,t.location=e.location,t.destination=Object(g.b)(t.location,1e4),t.name=m.a.name.findName(),t.registered=!1,t.syncher=new y.a,t.offers=[],t.handleSelfMessages=t.handleSelfMessages.bind(Object(d.a)(t)),t.subFn=function(){},t.tickCount=0,t.firstOfferTick=0,t.stopped=!1,t}return Object(h.a)(r,t),Object(c.a)(r,[{key:"start",value:function(){var t=this;return void 0!==this.startPromise?this.startPromise:(this.startPromise=new Promise(function(){var r=Object(a.a)(i.a.mark(function r(n,a){var s,c;return i.a.wrap(function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,t.community;case 2:return s=r.sent,r.next=5,f.EcdsaKey.generate();case 5:return t.key=r.sent,r.next=8,f.ChainTree.newEmptyTree(s.blockservice,t.key);case 8:return t.tree=r.sent,r.next=11,t.tree.id();case 11:if(null!==(c=r.sent)){r.next=15;break}return a(new Error("error getting id")),r.abrupt("return");case 15:return t.id=c,t.messenger=new f.CommunityMessenger("integrationtest",32,t.key,e.from(t.id,"utf8"),s.node.pubsub),t.messenger.subscribe(t.id,t.handleSelfMessages),r.next=20,t.registerAsRider();case 20:n(t);case 21:case"end":return r.stop()}},r)}));return function(e,t){return r.apply(this,arguments)}}()),this.startPromise)}},{key:"stop",value:function(){w(this.name," dropped off"),void 0!==this.messenger&&void 0!==this.id&&this.messenger.unsubscribe(this.id,this.handleSelfMessages),this.emit("stopped"),this.stopped=!0}},{key:"registerAsRider",value:function(){var e=Object(a.a)(i.a.mark(function e(){var t,r=this;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(w(this.name," registering"),void 0!==this.messenger&&void 0!==this.tree){e.next=3;break}throw new Error("need a tree and messenger to registerAsDriver");case 3:return e.next=5,this.community;case 5:return t=e.sent,e.next=8,this.syncher.send(function(){if(void 0===r.tree)throw new Error("undefined tree");return w(r.name," set type to rider"),t.playTransactions(r.tree,[Object(f.setDataTransaction)("_decentracar/type","rider")])});case 8:return e.next=10,t.nextUpdate();case 10:w(this.name," publishing did registration"),this.messenger.publish(b.a,Object(b.e)({type:b.c.didRegistration,did:this.id}));case 12:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()},{key:"handleSelfMessages",value:function(){var e=Object(a.a)(i.a.mark(function e(t){var r,n;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:r=Object(b.b)(t.getPayload_asU8()),e.t0=r.type,e.next=e.t0===b.c.didRegistration?4:e.t0===b.c.offer?8:e.t0===b.c.riding?10:e.t0===b.c.dropoff?13:15;break;case 4:return this.registered=!0,w(this.name," registered"),this.askForRide(),e.abrupt("break",15);case 8:return this.possiblyAcceptRide(r),e.abrupt("break",15);case 10:return n=r,this.location=new l.a(n.location[0],n.location[1]),e.abrupt("break",15);case 13:return this.stop(),e.abrupt("break",15);case 15:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"possiblyAcceptRide",value:function(e){var t=this;void 0===this.acceptedDriver?(this.offers.push(e),1===this.offers.length&&this.once("tick",function(){var e=void 0,r=-1,n=!0,i=!1,a=void 0;try{for(var s,c=t.offers[Symbol.iterator]();!(n=(s=c.next()).done);n=!0){var o=s.value,u=t.location.dist(new l.a(o.driverLocation[0],o.driverLocation[1]));(-1===r||u<r)&&(e=o,r=u)}}catch(d){i=!0,a=d}finally{try{n||null==c.return||c.return()}finally{if(i)throw a}}if(void 0===e)throw new Error("no closest offer, this state should never happen, but in the loop");t.acceptRide(e)})):this.rejectRide(e)}},{key:"rejectRide",value:function(){var e=Object(a.a)(i.a.mark(function e(t){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.messenger){e.next=2;break}throw new Error("must have a messenger and an id");case 2:this.messenger.publish(t.driverDid,Object(b.e)({type:b.c.offerReject,offer:t}));case 3:case"end":return e.stop()}},e,this)}));return function(t){return e.apply(this,arguments)}}()},{key:"acceptRide",value:function(){var e=Object(a.a)(i.a.mark(function e(t){var r,n,a,s,c,o,u,d=this;return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.messenger&&null!=this.id){e.next=2;break}throw new Error("must have a messenger and an id");case 2:return w(this.name," acceppting ride from: ",t.driverDid),this.acceptedDriver=t.driverDid,e.next=6,this.community;case 6:return r=e.sent,e.next=9,this.syncher.send(function(){if(void 0===d.tree)throw new Error("undefined tree");return r.playTransactions(d.tree,[Object(f.setDataTransaction)("/_decentracar/accepted",t.driverDid)])});case 9:for(this.messenger.publish(t.driverDid,Object(b.e)({type:b.c.offerAccept,riderDid:this.id,location:[this.location.x,this.location.y],destination:[this.destination.x,this.destination.y]})),n=!0,a=!1,s=void 0,e.prev=13,c=this.offers[Symbol.iterator]();!(n=(o=c.next()).done);n=!0)(u=o.value)!==t&&this.rejectRide(u);e.next=21;break;case 17:e.prev=17,e.t0=e.catch(13),a=!0,s=e.t0;case 21:e.prev=21,e.prev=22,n||null==c.return||c.return();case 24:if(e.prev=24,!a){e.next=27;break}throw s;case 27:return e.finish(24);case 28:return e.finish(21);case 29:this.offers=[];case 30:case"end":return e.stop()}},e,this,[[13,17,21,29],[22,,24,28]])}));return function(t){return e.apply(this,arguments)}}()},{key:"tick",value:function(){this.tickCount++,this.emit("tick",this.tickCount)}},{key:"askForRide",value:function(){var e=Object(a.a)(i.a.mark(function e(){return i.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0!==this.messenger&&null!=this.id){e.next=2;break}throw new Error("must have a messenger and an id");case 2:w(this.name," asking for ride"),this.messenger.publish(b.d,Object(b.e)({type:b.c.rideRequest,riderDID:this.id,location:[this.location.x,this.location.y]}));case 4:case"end":return e.stop()}},e,this)}));return function(){return e.apply(this,arguments)}}()}]),r}(v.EventEmitter)}).call(this,r(0).Buffer)},494:function(e,t,r){e.exports=r(2230)},499:function(e,t,r){},502:function(e,t,r){},528:function(e,t){function r(e){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}r.keys=function(){return[]},r.resolve=r,e.exports=r,r.id=528},530:function(e,t){},532:function(e,t){},56:function(e,t,r){"use strict";var n=r(38),i=r(36),a=function(){function e(t,r){Object(n.a)(this,e),this.x=void 0,this.y=void 0,this.x=t,this.y=r}return Object(i.a)(e,[{key:"set",value:function(e,t){return this.x=e,this.y=t,this}},{key:"add",value:function(e){return this.x+=e.x,this.y+=e.y,this}},{key:"sub",value:function(e){return this.x-=e.x,this.y-=e.y,this}},{key:"mul",value:function(e){return this.x*=e,this.y*=e,this}},{key:"div",value:function(e){return!e&&console.log("Division by zero!"),this.x/=e,this.y/=e,this}},{key:"mag",value:function(){return Math.sqrt(this.x*this.x+this.y*this.y)}},{key:"normalize",value:function(){var e=this.mag();return e&&this.div(e),this}},{key:"angle",value:function(){return Math.atan2(this.y,this.x)}},{key:"setMag",value:function(e){var t=this.angle();return this.x=e*Math.cos(t),this.y=e*Math.sin(t),this}},{key:"setAngle",value:function(e){var t=this.mag();return this.x=t*Math.cos(e),this.y=t*Math.sin(e),this}},{key:"rotate",value:function(e){return this.setAngle(this.angle()+e),this}},{key:"limit",value:function(e){return this.mag()>e&&this.setMag(e),this}},{key:"angleBetween",value:function(e){return this.angle()-e.angle()}},{key:"dot",value:function(e){return this.x*e.x+this.y*e.y}},{key:"lerp",value:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this}},{key:"dist",value:function(e){var t=this.x-e.x,r=this.y-e.y;return Math.sqrt(t*t+r*r)}},{key:"copy",value:function(){return new e(this.x,this.y)}}]),e}();t.a=a},565:function(e,t){},566:function(e,t){},613:function(e,t){},70:function(e,t,r){"use strict";r.d(t,"b",function(){return o}),r.d(t,"a",function(){return d});var n=r(38),i=r(36),a=r(6),s=r.n(a),c=r(10),o=new c.EventEmitter,u=function(){function e(t){Object(n.a)(this,e),this.debugger=void 0,this.name=void 0,this.name=t,this.debugger=s()(t),this.log=this.log.bind(this)}return Object(i.a)(e,[{key:"log",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];o.emit.apply(o,[this.name].concat(t)),this.debugger.apply(this,t)}}]),e}();function d(e){return new u(e).log}},711:function(e,t){},86:function(e,t,r){"use strict";r.d(t,"a",function(){return i}),r.d(t,"b",function(){return a});var n=r(56),i=new n.a(13.362029,52.491362);function a(e,t){var r=e.y,i=e.x,a=t/111300,s=Math.random(),c=Math.random(),o=a*Math.sqrt(s),u=2*Math.PI*c,d=o*Math.cos(u),h=o*Math.sin(u);return new n.a(d+i,h+r)}}},[[494,1,2]]]);
//# sourceMappingURL=main.34af3173.chunk.js.map